@startuml

interface ITradeDataProvider{
+ List<string> GetTradeData(Stream stream)
}
interface ITradeParser
{
 + List<TradeRecord> Parse(List<string> lines)
}
interface ITradeStorage
{
  + string Persist(List<TradeRecord> trades)
}

class DatabaseRepository {
- string _databasePath
+ DatabaseRepository(string databasePath)
+ void ClearAllTrades()
+ void InsertTrades(IEnumerable<TradeRecord> trades)
+ List<TradeRecord> GetAllTrades()
}

class TradeStorage {
- DatabaseRepository _databaseRepository
+ TradeStorage(DatabaseRepository databaseRepository)
+ string Persist(List<TradeRecord> trades)
}

class TradeDataProvider {
+ List<string> GetTradeData(Stream stream)
}
class TradeParser {
- const float LotSize = 100
+ List<TradeRecord> Parse(List<string> lines)
- static TradeRecord MapTradeDataToTradeRecord(IReadOnlyList<string> fields)
- static bool ValidateTradeData(IReadOnlyList<string> fields, int currentLine)
}

note right of TradeParser::MapTradeDataToTradeRecord
static method since it does not use any instance data
end note
note right of TradeParser::ValidateTradeData
static method since it does not use any instance data
end note


class TradeProcessor {
 - readonly ITradeParser _tradeParser;
 - readonly ITradeStorage _tradeStorage;
 - readonly ITradeDataProvider _tradeDataProvider
 + TradeProcessor(ITradeParser tradeParser, ITradeStorage tradeStorage, ITradeDataProvider tradeDataProvider)
 + void ProcessTrades(Stream stream)
}

note top of TradeProcessor
    Can no longer be static since it uses instance data 
end note
note right of TradeProcessor::TradeProcessor
    Constructor injection 
end note

TradeProcessor o---ITradeParser
TradeProcessor o---ITradeDataProvider
TradeProcessor o---ITradeStorage

TradeParser ...up|> ITradeParser
TradeStorage ...up|> ITradeStorage
TradeDataProvider ...up|> ITradeDataProvider

TradeStorage o---DatabaseRepository

note right of TradeDataProvider::GetTradeData
    Can no longer be static
end note

note right of TradeStorage::TradeStorage
    Depends on concrete DatabaseRepository
    (volatile dependency)
end note

note right of DatabaseRepository
    Wraps all database operations
    (volatile dependency that should be abstracted)
end note




@enduml
